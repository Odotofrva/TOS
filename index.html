<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TRAP-OF-STICKS</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;800&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --red:#e60012;
  --red2:#ff3b30;
  --bg:#0b0b0f;
  --panel:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.14);
  --text:rgba(255,255,255,.94);
  --muted:rgba(255,255,255,.65);
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --glow:0 0 24px rgba(230,0,18,.25);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:"Rajdhani",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  overflow-x:hidden;
}

/* üéÆüå´Ô∏è Background overlay (gaming accessories + smoke), low opacity */
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  pointer-events:none;
  background:
    linear-gradient(rgba(0,0,0,.78), rgba(0,0,0,.78)),
    url("https://images.unsplash.com/photo-1593305841991-05c297ba4575?auto=format&fit=crop&w=2000&q=80"),
    url("https://images.unsplash.com/photo-1526312426976-f4d754fa9bd6?auto=format&fit=crop&w=2000&q=80");
  background-size: cover, cover, cover;
  background-position: center, center, center;
  background-repeat:no-repeat;
  opacity:0.18;
}

/* ---------- SPLASH ---------- */
.splash{
  position:fixed; inset:0; z-index:9999;
  display:grid; place-items:center;
  background:rgba(0,0,0,.85);
  backdrop-filter: blur(10px);
}
.splash-inner{ text-align:center; width:min(520px, calc(100% - 32px)); }
.splash-logo{
  width:180px; height:180px;
  margin:0 auto 14px;
  display:grid; place-items:center;
  background:transparent;
}
.splash-logo img{ width:100%; height:100%; object-fit:contain; display:none; }
.splash-logo .logo-text{
  font-family:"Orbitron";
  letter-spacing:1px;
  font-size:56px;
  text-transform:uppercase;
}
.splash-sub{ color:var(--muted); margin:0 0 14px; }
.bar{
  width:min(360px, 100%);
  height:10px;
  margin:0 auto;
  background:rgba(255,255,255,.12);
  border-radius:999px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
}
.bar div{
  height:100%; width:0%;
  background:linear-gradient(90deg,var(--red), rgba(255,255,255,.7), var(--red2));
  box-shadow:0 0 18px rgba(230,0,18,.35);
  border-radius:999px;
}

/* ---------- APP ---------- */
.app{ opacity:0; transform:translateY(6px); transition:opacity .3s ease, transform .3s ease; }
.app.ready{ opacity:1; transform:translateY(0); }

/* ---------- TOP BAR ---------- */
.topbar{
  position:sticky; top:0; z-index:10;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
}
.topbar-inner{
  max-width:1200px;
  margin:auto;
  padding:14px 16px;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  gap:12px;
}
.center-brand{ text-align:center; display:grid; gap:8px; justify-items:center; }
.top-logo{
  width:120px; height:120px;
  display:grid; place-items:center;
  background:transparent;
}
.top-logo img{ width:100%; height:100%; object-fit:contain; display:none; }
.logo-text{
  font-family:"Orbitron";
  letter-spacing:1px;
  font-size:16px;
  text-transform:uppercase;
}
.right-actions{ display:flex; justify-content:flex-end; gap:10px; align-items:center; flex-wrap:wrap; }

.btn{
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  color:white;
  padding:10px 14px;
  border-radius:12px;
  font-family:"Orbitron";
  cursor:pointer;
  text-transform:uppercase;
  letter-spacing:.4px;
}
.btn.primary{
  border-color:rgba(230,0,18,.65);
  background:rgba(230,0,18,.18);
  box-shadow:0 0 20px rgba(230,0,18,.18);
}
.btn:hover{ background:rgba(255,255,255,.09); }
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  font-family:"Orbitron";
  font-size:12px;
  text-transform:uppercase;
}
.badge b{ color:rgba(255,255,255,.92); }

/* ---------- LAYOUT ---------- */
.wrap{ max-width:1200px; margin:auto; padding:16px; }
.grid{ display:grid; gap:16px; }
@media(min-width:960px){ .grid{ grid-template-columns:420px 1fr; } }

/* ---------- COMMERCIAL HERO ---------- */
.hero{
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  overflow:hidden;
  box-shadow:var(--shadow);
  margin-bottom:16px;
}
.hero-top{
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,.12);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.hero-title{
  font-family:"Orbitron";
  font-size:14px;
  text-transform:uppercase;
  margin:0;
}
.hero-sub{ color:var(--muted); font-size:12px; margin:2px 0 0; }
.hero-body{ padding:14px; display:grid; gap:12px; }
.hero-video{
  border-radius:16px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  box-shadow:0 0 26px rgba(230,0,18,.12);
}
.ratio{ position:relative; padding-top:56.25%; }
.ratio iframe{
  position:absolute; inset:0; width:100%; height:100%;
  border:0;
}
.hero-cta{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.pill{
  font-size:12px;
  color:rgba(255,255,255,.9);
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  padding:8px 10px;
  border-radius:999px;
  text-transform:uppercase;
  font-family:"Orbitron";
  letter-spacing:.3px;
}

/* ---------- PANELS ---------- */
.players,.panel{
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  overflow:hidden;
  box-shadow:var(--shadow);
}
.players-header,.panel-header{
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,.12);
  font-family:"Orbitron";
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.panel-header small{ color:var(--muted); font-family:"Rajdhani"; }

/* ---------- PLAYER CARDS ---------- */
.player-card{
  position:relative;
  display:grid;
  grid-template-columns:56px 1fr auto;
  gap:12px;
  padding:12px 14px;
  cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,.06);
  overflow:hidden;
}
.player-card:hover{ background:rgba(255,255,255,.04); }
.player-card:last-child{ border-bottom:0; }

.avatar{
  width:56px; height:56px;
  border-radius:14px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
}
.avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

.name{ font-family:"Orbitron"; font-size:13px; text-transform:uppercase; }
.meta{ font-size:12px; color:var(--muted); margin-top:4px; }

.status{
  align-self:start;
  font-family:"Orbitron";
  font-size:11px;
  text-transform:uppercase;
  color:var(--muted);
  display:flex;
  gap:8px;
  align-items:center;
}
.dot{
  width:9px; height:9px; border-radius:999px;
  background:rgba(255,255,255,.25);
}
.status.live{ color:rgba(255,255,255,.92); }
.status.live .dot{ background:var(--red); box-shadow:0 0 0 4px rgba(230,0,18,.18); }

.rank-pill{
  display:inline-flex;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(230,0,18,.35);
  background:rgba(230,0,18,.12);
  font-family:"Orbitron";
  font-size:11px;
  text-transform:uppercase;
}

/* ‚úÖ Active card + red glow behind it */
.player-card.active{
  border-left:3px solid var(--red);
  background:linear-gradient(90deg, rgba(230,0,18,.18), rgba(255,255,255,.03));
}
.player-card.active::before{
  content:"";
  position:absolute;
  inset:-30px;
  z-index:-1;
  background:radial-gradient(circle at 18% 50%, rgba(230,0,18,.55), transparent 60%);
  filter: blur(18px);
  opacity: .55;
}

/* ---------- STREAM + PROFILE ---------- */
.panel-body{ padding:14px; display:grid; gap:12px; }
.hint{ color:var(--muted); font-size:12px; line-height:1.4; }

.stream-shell{
  border-radius:16px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  box-shadow:0 0 26px rgba(230,0,18,.12);
}
@media(min-width:960px){
  .stream-shell{ display:grid; grid-template-columns:1fr 360px; }
  .video-shell{ border-right:1px solid rgba(255,255,255,.12); }
  .chat-shell{ display:block; }
}
.chat-shell{ display:none; }

.profile{
  padding:12px;
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:rgba(255,255,255,.04);
}
.profile-top{
  display:grid;
  grid-template-columns:72px 1fr;
  gap:12px;
  align-items:center;
}
.profile-top .avatar{ width:72px; height:72px; border-radius:18px; }
.profile h3{ margin:0; font-family:"Orbitron"; text-transform:uppercase; font-size:16px; }
.profile .handle{ margin-top:4px; color:var(--muted); font-size:12px; }
.kv{ display:grid; gap:10px; margin-top:12px; }
.kv-row{
  display:grid;
  grid-template-columns:1fr auto;
  gap:10px;
  align-items:center;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
}
.k{ color:var(--muted); font-size:12px; }
.v{ font-family:"Orbitron"; font-size:12px; text-transform:uppercase; }
.bio{ margin-top:12px; color:rgba(255,255,255,.82); font-size:13px; line-height:1.45; }
.links{ margin-top:12px; display:flex; flex-wrap:wrap; gap:10px; }
.link{
  display:inline-flex; gap:8px; align-items:center;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:rgba(255,255,255,.92);
  text-decoration:none;
  font-family:"Orbitron";
  font-size:12px;
  text-transform:uppercase;
}

/* Profile actions */
.actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:12px;
}
.actions .btn{ flex:1 1 160px; }

/* ---------- MODALS ---------- */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  place-items:center;
  z-index:100;
  padding:16px;
}
.modal.open{ display:grid; }
.modal-card{
  background:rgba(15,15,18,.92);
  border:1px solid rgba(255,255,255,.18);
  border-radius:18px;
  width:100%;
  max-width:520px;
  overflow:hidden;
  box-shadow:var(--shadow), var(--glow);
}
.modal-top{
  padding:12px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid rgba(255,255,255,.14);
}
.modal-body{ padding:14px; display:grid; gap:12px; }
.field label{ font-size:12px; color:var(--muted); }
.field input{
  width:100%;
  padding:12px;
  border-radius:14px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.18);
  color:var(--text);
  outline:none;
  font-family:"Rajdhani",sans-serif;
}
.field input:focus{ 
  border-color:rgba(230,0,18,.55);
  box-shadow:0 0 0 4px rgba(230,0,18,.18);
}
.success{ color:rgba(255,255,255,.92); }
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.row .btn{ flex:1 1 160px; }
</style>
</head>

<body>

<!-- SPLASH (3s) -->
<div class="splash" id="splash">
  <div class="splash-inner">
    <div class="splash-logo" aria-label="Logo">
      <img id="splashLogoImg" src="" alt="TRAP-OF-STICKS Logo">
      <div id="splashLogoText" class="logo-text">TOS</div>
    </div>
    <p class="splash-sub">Loading arena‚Ä¶</p>
    <div class="bar"><div id="barFill"></div></div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app">
  <div class="topbar">
    <div class="topbar-inner">
      <div></div>

      <div class="center-brand">
        <div class="top-logo" aria-label="Top Logo">
          <img id="topLogoImg" src="" alt="TRAP-OF-STICKS Logo">
          <div id="topLogoText" class="logo-text">TOS</div>
        </div>
        <div class="logo-text">TRAP-OF-STICKS</div>
      </div>

      <div class="right-actions">
        <div class="badge" id="authBadge" style="display:none;">
          Logged in: <b id="authUser">‚Äî</b>
        </div>
        <button class="btn" id="loginBtn" type="button">Log In</button>
        <button class="btn primary" id="signupBtn" type="button">Sign Up</button>
        <button class="btn" id="logoutBtn" type="button" style="display:none;">Log Out</button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <!-- COMMERCIAL -->
    <section class="hero" aria-label="Brand Commercial">
      <div class="hero-top">
        <div>
          <h2 class="hero-title">TOS Commercial</h2>
          <div class="hero-sub">TRAP-OF-STICKS ‚Ä¢ Gaming ‚Ä¢ Cannabis ‚Ä¢ Community</div>
        </div>
        <span class="pill">Now Playing</span>
      </div>

      <div class="hero-body">
        <div class="hero-video">
          <div class="ratio">
            
            <iframe width="560" height="315" src="https://www.youtube.com/embed/hI9gPuGN07c?si=0SXxvKd6He9WluMJ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
          </div>
        </div>

        <div class="hero-cta">
          
          <button class="btn primary" id="heroSignupBtn" type="button">Join the Crew</button>
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- Players -->
      <section class="players" aria-label="Players">
        <div class="players-header">
          <div>TOS Players</div>
          <small id="playerCount">0</small>
        </div>
        <div id="playerList"></div>
      </section>

      <!-- Stream + Profile -->
      <section class="panel" aria-label="Stream & Profile">
        <div class="panel-header">
          <div>TOS Live Stream</div>
          <small id="streamTitle">Select a player</small>
        </div>

        <div class="panel-body">
          <div class="hint">
            <!--‚ö†Ô∏è Twitch embeds require your deployed domain in <b>parent</b>.
            Update <code>PARENTS</code> in JS (include your domain + www). -->
          </div>

          <div class="stream-shell">
            <div class="video-shell">
              <div class="ratio">
                <iframe id="playerFrame" title="Twitch Player" allowfullscreen allow="autoplay; fullscreen" src=""></iframe>
              </div>
            </div>

            <!-- Desktop-only chat -->
            <div class="chat-shell">
              <div class="ratio" style="padding-top:0; height:520px;">
                <iframe id="chatFrame" title="Twitch Chat" src="" scrolling="no"></iframe>
              </div>
            </div>
          </div>

          <div class="profile">
            <div class="profile-top">
              <div class="avatar"><img id="profilePhoto" alt="Player photo" src=""></div>
              <div>
                <h3 id="profileName">‚Äî</h3>
                <div class="handle" id="profileHandle">Select a TOS Player to load profile + stream.</div>
              </div>
            </div>

            <div class="kv" id="profileKv"></div>
            <div class="bio" id="profileBio"></div>

            <div class="actions">
              <button class="btn primary" id="subscribeBtn" type="button">Subscribe</button>
              <button class="btn" id="logStreamBtn" type="button">TOS Log Stream Session</button>
            </div>
            <div class="hint" id="subscribeHint" style="margin-top:10px;">
              Subscribing requires login.
            </div>

            <div class="links">
              <a class="link" id="twitchLink" href="#" target="_blank" rel="noreferrer">TOS Twitch</a>
              <a class="link" id="igLink" href="#" target="_blank" rel="noreferrer">TOS Instagram</a>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- SIGNUP MODAL -->
  <div class="modal" id="signupModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-top">
        <div class="logo-text" style="font-size:14px;">Create Account</div>
        <button class="btn" id="closeSignupBtn" type="button">Close</button>
      </div>

      <div class="modal-body">
        <div class="hint"><!--Demo auth (localStorage). Good for prototype; swap to real auth later.--></div>

        <form id="signupForm" style="display:grid; gap:12px;">
          <div class="field">
            <label for="suUsername">TOS Username</label>
            <input id="suUsername" name="username" required minlength="3" maxlength="20" placeholder="TrapSniper" />
          </div>

          <div class="field">
            <label for="suEmail">Email</label>
            <input id="suEmail" name="email" type="email" required placeholder="you@email.com" />
          </div>

          <div class="field">
            <label for="suPassword">TOS Password</label>
            <input id="suPassword" name="password" type="password" required minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>

          <button class="btn primary" type="submit" style="width:100%; padding:12px 14px;">Create TOS Account</button>
          <div id="signupResult" class="hint success" style="display:none;"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-top">
        <div class="logo-text" style="font-size:14px;">Log In</div>
        <button class="btn" id="closeLoginBtn" type="button">Close</button>
      </div>

      <div class="modal-body">
        <div class="hint">Use the username + password you created on Sign Up.</div>

        <form id="loginForm" style="display:grid; gap:12px;">
          <div class="field">
            <label for="liUsername">TOS Username</label>
            <input id="liUsername" name="username" required placeholder="TrapSniper" />
          </div>

          <div class="field">
            <label for="liPassword">TOS Password</label>
            <input id="liPassword" name="password" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>

          <button class="btn primary" type="submit" style="width:100%; padding:12px 14px;">Log In</button>
          <div id="loginResult" class="hint success" style="display:none;"></div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const SPLASH_DURATION_MS = 3000;

// ‚úÖ Replace with your deployed domain(s)
const PARENTS = ["localhost", "YOUR_DOMAIN.com", "www.YOUR_DOMAIN.com"];

// Optional logo image (PNG/SVG). Put a real path like "assets/logo.svg"
const LOGO_SRC = "";

/* ---------------- DATA ---------------- */
const BASE_PLAYERS = [
  {
    id:"p1",
    displayName:"SmokeRunner",
    twitchChannel:"smokerunner",
    photo:"https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&w=800&q=70",
    city:"Queens", state:"NY",
    instagram:"smokerunner",
    games:["Call of Duty","NBA2K"],
    bio:"Fast rotations, clean comms. COD + 2K nights. Catch me live‚Äîno excuses, just buckets and W‚Äôs.",
    tags:["COD","2K"]
  },
  {
    id:"p2",
    displayName:"OdotNYC",
    twitchChannel:"odotNYC",
    photo:"https://images.unsplash.com/photo-1612287230202-1ff1d85d1bdf?auto=format&fit=crop&w=800&q=70",
    city:"Brooklyn", state:"NY",
    instagram:"odotnyc",
    games:["NBA2K","Call of Duty"],
    bio:"Two-way menace. Lockdown defense in 2K, disciplined pushes in COD. Vibes stay up.",
    tags:["2K","COD"]
  },
  {
    id:"p3",
    displayName:"QueensClutch",
    twitchChannel:"queensclutch",
    photo:"https://images.unsplash.com/photo-1520975682031-a7a79f0b0d1a?auto=format&fit=crop&w=800&q=70",
    city:"Jamaica", state:"NY",
    instagram:"queensclutch",
    games:["Call of Duty"],
    bio:"Long shots and late-game clutches. If it‚Äôs 1v3, I like my odds.",
    tags:["COD"]
  },
  {
    id:"p4",
    displayName:"2KBackcourt",
    twitchChannel:"2kbackcourt",
    photo:"https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=800&q=70",
    city:"Long Island City", state:"NY",
    instagram:"2kbackcourt",
    games:["NBA2K"],
    bio:"Pick-and-roll maestro. Dimes, fades, and tight defense. 2K runs nightly.",
    tags:["2K"]
  }
];

/* ---------------- STORAGE KEYS ---------------- */
const LS_USERS = "tos_users_v1";            // { username: {password, email} }
const LS_SESSION = "tos_session_v1";        // { username }
const LS_PLAYER_STATS = "tos_player_stats"; // { playerId: {streamCount:number, subscribers:[username,...]} }

/* ---------------- DOM ---------------- */
const splash = document.getElementById("splash");
const barFill = document.getElementById("barFill");
const app = document.getElementById("app");

const splashLogoImg = document.getElementById("splashLogoImg");
const splashLogoText = document.getElementById("splashLogoText");
const topLogoImg = document.getElementById("topLogoImg");
const topLogoText = document.getElementById("topLogoText");

const playerListEl = document.getElementById("playerList");
const playerCountEl = document.getElementById("playerCount");

const streamTitle = document.getElementById("streamTitle");
const playerFrame = document.getElementById("playerFrame");
const chatFrame = document.getElementById("chatFrame");

const profilePhoto = document.getElementById("profilePhoto");
const profileName = document.getElementById("profileName");
const profileHandle = document.getElementById("profileHandle");
const profileKv = document.getElementById("profileKv");
const profileBio = document.getElementById("profileBio");
const twitchLink = document.getElementById("twitchLink");
const igLink = document.getElementById("igLink");

const subscribeBtn = document.getElementById("subscribeBtn");
const logStreamBtn = document.getElementById("logStreamBtn");
const subscribeHint = document.getElementById("subscribeHint");

const signupBtn = document.getElementById("signupBtn");
const heroSignupBtn = document.getElementById("heroSignupBtn");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

const authBadge = document.getElementById("authBadge");
const authUser = document.getElementById("authUser");

const signupModal = document.getElementById("signupModal");
const closeSignupBtn = document.getElementById("closeSignupBtn");
const signupForm = document.getElementById("signupForm");
const signupResult = document.getElementById("signupResult");

const loginModal = document.getElementById("loginModal");
const closeLoginBtn = document.getElementById("closeLoginBtn");
const loginForm = document.getElementById("loginForm");
const loginResult = document.getElementById("loginResult");

/* ---------------- STATE ---------------- */
let selectedPlayerId = BASE_PLAYERS[0].id;

/* ---------------- HELPERS: LocalStorage ---------------- */
function loadJson(key, fallback){
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch { return fallback; }
}
function saveJson(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

/* ---------------- AUTH ---------------- */
function getUsers(){
  return loadJson(LS_USERS, {});
}
function setUsers(users){
  saveJson(LS_USERS, users);
}
function getSession(){
  return loadJson(LS_SESSION, null);
}
function setSession(session){
  saveJson(LS_SESSION, session);
}
function clearSession(){
  localStorage.removeItem(LS_SESSION);
}
function currentUsername(){
  const s = getSession();
  return s?.username || null;
}
function refreshAuthUI(){
  const u = currentUsername();
  if (u){
    authBadge.style.display = "inline-flex";
    authUser.textContent = u;
    logoutBtn.style.display = "inline-block";
    loginBtn.style.display = "none";
  } else {
    authBadge.style.display = "none";
    logoutBtn.style.display = "none";
    loginBtn.style.display = "inline-block";
  }
  updateSubscribeButton();
}

/* ---------------- PLAYER STATS: streams + subs ---------------- */
function getPlayerStatsAll(){
  return loadJson(LS_PLAYER_STATS, {});
}
function setPlayerStatsAll(obj){
  saveJson(LS_PLAYER_STATS, obj);
}
function ensurePlayerStats(playerId){
  const all = getPlayerStatsAll();
  if (!all[playerId]){
    all[playerId] = { streamCount: 0, subscribers: [] };
    setPlayerStatsAll(all);
  }
  return all[playerId];
}
function getPlayerStats(playerId){
  const all = getPlayerStatsAll();
  return all[playerId] || { streamCount: 0, subscribers: [] };
}
function addStreamSession(playerId){
  const all = getPlayerStatsAll();
  const s = all[playerId] || { streamCount: 0, subscribers: [] };
  s.streamCount = (s.streamCount || 0) + 1;
  all[playerId] = s;
  setPlayerStatsAll(all);
}
function toggleSubscription(playerId, username){
  const all = getPlayerStatsAll();
  const s = all[playerId] || { streamCount: 0, subscribers: [] };
  const subs = new Set(s.subscribers || []);
  if (subs.has(username)) subs.delete(username);
  else subs.add(username);
  s.subscribers = Array.from(subs);
  all[playerId] = s;
  setPlayerStatsAll(all);
}
function isSubscribed(playerId, username){
  const s = getPlayerStats(playerId);
  return (s.subscribers || []).includes(username);
}
function subscriberCount(playerId){
  return (getPlayerStats(playerId).subscribers || []).length;
}

/* ---------------- RANK SYSTEM ----------------
   points = streams_on_platform * 10 + subscribers * 3
*/
function rankFromPoints(points){
  if (points >= 450) return "Legend";
  if (points >= 250) return "Elite";
  if (points >= 120) return "Pro";
  if (points >= 40)  return "Grinder";
  return "Rookie";
}
function computeRank(playerId){
  const s = getPlayerStats(playerId);
  const points = (s.streamCount || 0) * 10 + (s.subscribers?.length || 0) * 3;
  return { points, rank: rankFromPoints(points), streamCount: s.streamCount || 0, subs: s.subscribers?.length || 0 };
}

/* ---------------- TWITCH URLS ---------------- */
function buildTwitchPlayerUrl(channel){
  const parentParams = PARENTS.map(p => `parent=${encodeURIComponent(p)}`).join("&");
  return `https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&muted=true&autoplay=false&${parentParams}`;
}
function buildTwitchChatUrl(channel){
  const parentParams = PARENTS.map(p => `parent=${encodeURIComponent(p)}`).join("&");
  return `https://www.twitch.tv/embed/${encodeURIComponent(channel)}/chat?${parentParams}`;
}

/* ---------------- UI: Players list ---------------- */
function setActiveCard(playerId){
  document.querySelectorAll(".player-card").forEach(el=>{
    el.classList.toggle("active", el.dataset.id === playerId);
  });
}
function renderPlayers(){
  // ensure stats objects exist
  BASE_PLAYERS.forEach(p => ensurePlayerStats(p.id));

  playerListEl.innerHTML = "";
  playerCountEl.textContent = `${BASE_PLAYERS.length} total`;

  BASE_PLAYERS.forEach((p, idx)=>{
    const r = computeRank(p.id);

    const card = document.createElement("div");
    card.className = "player-card";
    card.dataset.id = p.id;

    // Demo live indicator (first is live)
    const isLive = idx === 0;
    const statusClass = isLive ? "status live" : "status";
    const statusText = isLive ? "LIVE" : "OFFLINE";

    card.innerHTML = `
      <div class="avatar"><img alt="${p.displayName} photo" src="${p.photo}"></div>
      <div>
        <div class="name">${p.displayName} <span class="rank-pill">${r.rank}</span></div>
        <div class="meta">${p.city}, ${p.state} ‚Ä¢ @${p.instagram}</div>
        <div class="meta">${p.games.join(" / ")}</div>
        <div class="meta">Streams: ${r.streamCount} ‚Ä¢ Subs: ${r.subs} ‚Ä¢ Points: ${r.points}</div>
      </div>
      <div class="${statusClass}">
        <span class="dot" aria-hidden="true"></span> ${statusText}
      </div>
    `;

    card.addEventListener("click", ()=>selectPlayer(p.id));
    playerListEl.appendChild(card);
  });

  setActiveCard(selectedPlayerId);
}

/* ---------------- UI: Profile ---------------- */
function updateSubscribeButton(){
  const u = currentUsername();
  if (!u){
    subscribeBtn.textContent = "Subscribe";
    subscribeBtn.classList.add("primary");
    subscribeHint.textContent = "Subscribing requires login.";
    return;
  }

  const subbed = isSubscribed(selectedPlayerId, u);
  subscribeBtn.textContent = subbed ? "Unsubscribe" : "Subscribe";
  subscribeBtn.classList.toggle("primary", !subbed);
  subscribeHint.textContent = subbed
    ? `You are subscribed as @${u}.`
    : `Logged in as @${u}. Subscribe to support this player.`;
}
function renderProfile(playerId){
  const p = BASE_PLAYERS.find(x => x.id === playerId);
  const r = computeRank(playerId);

  streamTitle.textContent = `${p.displayName} ‚Ä¢ ${p.games.join(" / ")} ‚Ä¢ ${r.rank}`;

  profilePhoto.src = p.photo;
  profileName.textContent = p.displayName;
  profileHandle.textContent = `${p.city}, ${p.state} ‚Ä¢ IG @${p.instagram} ‚Ä¢ Twitch ${p.twitchChannel}`;

  profileKv.innerHTML = "";
  const rows = [
    ["Rank", r.rank],
    ["Points", String(r.points)],
    ["Streams on Platform", String(r.streamCount)],
    ["Subscribers", String(r.subs)],
    ["Games", p.games.join(", ")],
  ];
  rows.forEach(([k,v])=>{
    const row = document.createElement("div");
    row.className = "kv-row";
    row.innerHTML = `<div class="k">${k}</div><div class="v">${v}</div>`;
    profileKv.appendChild(row);
  });

  profileBio.textContent = p.bio || "";
  twitchLink.href = `https://www.twitch.tv/${encodeURIComponent(p.twitchChannel)}`;
  igLink.href = `https://www.instagram.com/${encodeURIComponent(p.instagram)}/`;

  updateSubscribeButton();
}
function loadStream(playerId){
  const p = BASE_PLAYERS.find(x => x.id === playerId);
  playerFrame.src = buildTwitchPlayerUrl(p.twitchChannel);
  chatFrame.src = buildTwitchChatUrl(p.twitchChannel);
}
function selectPlayer(playerId){
  selectedPlayerId = playerId;
  setActiveCard(playerId);
  renderProfile(playerId);
  loadStream(playerId);
}

/* ---------------- Actions ---------------- */
subscribeBtn.addEventListener("click", ()=>{
  const u = currentUsername();
  if (!u){
    openLogin();
    return;
  }
  toggleSubscription(selectedPlayerId, u);
  renderPlayers();
  renderProfile(selectedPlayerId);
});

logStreamBtn.addEventListener("click", ()=>{
  // In a real build: only the streamer (player account) would do this when they go live via platform integration.
  addStreamSession(selectedPlayerId);
  renderPlayers();
  renderProfile(selectedPlayerId);
});

/* ---------------- MODALS ---------------- */
function openModal(el){
  el.classList.add("open");
  el.setAttribute("aria-hidden","false");
}
function closeModal(el){
  el.classList.remove("open");
  el.setAttribute("aria-hidden","true");
}

function openSignup(){ openModal(signupModal); }
function closeSignup(){
  closeModal(signupModal);
  signupResult.style.display = "none";
  signupResult.textContent = "";
}
function openLogin(){ openModal(loginModal); }
function closeLogin(){
  closeModal(loginModal);
  loginResult.style.display = "none";
  loginResult.textContent = "";
}

signupBtn.addEventListener("click", openSignup);
heroSignupBtn.addEventListener("click", openSignup);
closeSignupBtn.addEventListener("click", closeSignup);
signupModal.addEventListener("click", (e)=>{ if(e.target === signupModal) closeSignup(); });

loginBtn.addEventListener("click", openLogin);
closeLoginBtn.addEventListener("click", closeLogin);
loginModal.addEventListener("click", (e)=>{ if(e.target === loginModal) closeLogin(); });

logoutBtn.addEventListener("click", ()=>{
  clearSession();
  refreshAuthUI();
});

signupForm.addEventListener("submit", (e)=>{
  e.preventDefault();
  const users = getUsers();
  const username = signupForm.username.value.trim();
  const email = signupForm.email.value.trim();
  const password = signupForm.password.value;

  if (users[username]){
    signupResult.style.display = "block";
    signupResult.textContent = "‚ùå Username already exists. Try another.";
    return;
  }

  users[username] = { email, password };
  setUsers(users);

  signupResult.style.display = "block";
  signupResult.textContent = `‚úÖ Account created for @${username}. You can log in now.`;
  signupForm.reset();
});

loginForm.addEventListener("submit", (e)=>{
  e.preventDefault();
  const users = getUsers();
  const username = loginForm.username.value.trim();
  const password = loginForm.password.value;

  const user = users[username];
  if (!user || user.password !== password){
    loginResult.style.display = "block";
    loginResult.textContent = "‚ùå Invalid username or password.";
    return;
  }

  setSession({ username });
  loginResult.style.display = "block";
  loginResult.textContent = `‚úÖ Logged in as @${username}.`;
  refreshAuthUI();

  setTimeout(()=>closeLogin(), 700);
});

/* ---------------- SPLASH (exact 3s) ---------------- */
function startSplash(){
  if (LOGO_SRC){
    splashLogoImg.src = LOGO_SRC;
    topLogoImg.src = LOGO_SRC;

    splashLogoImg.style.display = "block";
    topLogoImg.style.display = "block";

    splashLogoText.style.display = "none";
    topLogoText.style.display = "none";
  }

  const start = performance.now();
  function tick(now){
    const elapsed = now - start;
    const pct = Math.min(1, elapsed / SPLASH_DURATION_MS);
    barFill.style.width = `${pct * 100}%`;

    if (pct < 1) requestAnimationFrame(tick);
    else {
      splash.style.display = "none";
      app.classList.add("ready");
    }
  }
  requestAnimationFrame(tick);
}

/* ---------------- INIT ---------------- */
BASE_PLAYERS.forEach(p => ensurePlayerStats(p.id));
renderPlayers();
selectPlayer(selectedPlayerId);
refreshAuthUI();
startSplash();
</script>

</body>
</html>
